<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>nginx_source.rb</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div id="jump_to">
    Jump To &hellip;
    <div id="jump_wrapper">
      <div id="jump_page">
          <a class="source" href="../../../config/solo.html">solo.rb</a>
          <a class="source" href="motd.html">motd.rb</a>
          <a class="source" href="nginx_package.html">nginx_package.rb</a>
          <a class="source" href="nginx_source.html">nginx_source.rb</a>
          <a class="source" href="../../../../refactored/config/solo.html">solo.rb</a>
          <a class="source" href="../../../../refactored/cookbooks/nginx/recipes/default.html">default.rb</a>
          <a class="source" href="../../../../refactored/cookbooks/nginx/recipes/package.html">package.rb</a>
          <a class="source" href="../../../../refactored/cookbooks/nginx/recipes/source.html">source.rb</a>
      </div>
    </div>
  </div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>nginx_source.rb</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-Variables'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Variables">&#182;</a>
        </div>
        <h2>Variables</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <p>The directory that the tarballs will be downloaded to.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">cache_dir</span>     <span class="o">=</span> <span class="s2">&quot;/var/cache/downloads&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p>The full URL to download the nginx tarball.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">tar_url</span>       <span class="o">=</span> <span class="s2">&quot;http://nginx.org/download/nginx-0.9.7.tar.gz&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-4">&#182;</a>
        </div>
        <p>The SHA256 checksum for the downloaded file. Chef can check to see if
the downloaded tarball copy validates and if so it will skip going
to the network to re-download and verify.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">tar_checksum</span>  <span class="o">=</span> <span class="s2">&quot;2feb0acee473cc360a620ee862907b9570a4121956c40cbd27da35f5b0a96045&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p>The name of the tarball without the URL at the beggining. There is more
than one way to do this, but splits are fun.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">tar_file</span>      <span class="o">=</span> <span class="n">tar_url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <p>The directory that will get created when extracting the tarball.
Same string mangling tricks here too but this time using <code>sub</code> to strip
off the file extension.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">tar_dir</span>       <span class="o">=</span> <span class="n">tar_file</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sr">/\.tar\.gz$/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <p>The configure flags used when configuring nginx. We&rsquo;re targetting
a custom directory in <code>/opt</code> so that multiple built versions of
nginx can co-exist together. We&rsquo;re also enabling the SSL module
which is bound to be used sooner or later.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">configure_flags</span> <span class="o">=</span> <span class="o">[</span>
  <span class="s2">&quot;--prefix=/opt/</span><span class="si">#{</span><span class="n">tar_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
  <span class="s2">&quot;--conf-path=/etc/nginx/nginx.conf&quot;</span><span class="p">,</span>
  <span class="s2">&quot;--with-http_ssl_module&quot;</span>
<span class="o">]</span></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <p>A list of Ubuntu packages that must be installed prior to
compiling nginx. We don&rsquo;t need <em>wget</em> anymore as Chef will
download files for us just fine. The funny <code>%w{ .. }</code> is a
Ruby array of words, so <code>%w{ one two }</code> gives you
`[ &ldquo;one&rdquo;, &ldquo;two&rdquo; ]. Neat, no?</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">pkgs</span> <span class="o">=</span> <span class="sx">%w{ build-essential binutils-doc autoconf flex bison</span>
<span class="sx">           libpcre3 libpcre3-dev libssl-dev }</span></pre></div>
      </td>
    </tr>
    <tr id='section-Install_Pre-requisite_Packages'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Install_Pre-requisite_Packages">&#182;</a>
        </div>
        <h2>Install Pre-requisite Packages</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <p>Loop through the <code>pkgs</code> array and install each package.
You are seeing a Ruby block in action here where <code>pkg</code>
is set to the value of the current array element.</p>

<p>The <code>action</code> attribute is set to <code>:install</code> which is
actually the default so you can leave it off. But we&rsquo;re
still learning here, right?</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">pkgs</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">pkg</span><span class="o">|</span>
  <span class="n">package</span> <span class="n">pkg</span> <span class="k">do</span>
    <span class="n">action</span> <span class="ss">:install</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-Fetching_and_Extraction'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Fetching_and_Extraction">&#182;</a>
        </div>
        <h2>Fetching and Extraction</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-12'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-12">&#182;</a>
        </div>
        <p>Ensure that the <code>cache_dir</code> directory exists and has
sane permissions and ownership. Again <code>owner</code>, <code>group</code>,
and <code>action</code> are all defaults (assuming your running chef
as <em>root</em>). The <code>recursive</code> attribute ensures that all
parent directories exist, much like the <code>-p</code> flag in
<code>mkdir</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">directory</span> <span class="n">cache_dir</span> <span class="k">do</span>
  <span class="n">owner</span>       <span class="s2">&quot;root&quot;</span>
  <span class="n">group</span>       <span class="s2">&quot;root&quot;</span>
  <span class="n">mode</span>        <span class="s2">&quot;0755&quot;</span>
  <span class="n">recursive</span>   <span class="kp">true</span>
  <span class="n">action</span>      <span class="ss">:create</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-13'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-13">&#182;</a>
        </div>
        <p>Download the the nginx tarball into the <code>cache_dir</code>
directory. The name of the <code>remote_file</code> resource
which is <code>"#{cache_dir}/#{tar_file}"</code> declares
the intended target location on your system for this
file.</p>

<p>The <code>source</code> attribute sets up your download URL,
and the <code>checksum</code> attribute makes <code>remote_file</code>
check the downloaded file first. If the checksums
match, the file will not be re-downloaded. Otherwise,
it will download this file everytime in order to
keep it fresh.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">remote_file</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">cache_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">tar_file</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">do</span>
  <span class="n">source</span>      <span class="n">tar_url</span>
  <span class="n">checksum</span>    <span class="n">tar_checksum</span>
  <span class="n">owner</span>       <span class="s2">&quot;root&quot;</span>
  <span class="n">group</span>       <span class="s2">&quot;root&quot;</span>
  <span class="n">mode</span>        <span class="s2">&quot;0644&quot;</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-14'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-14">&#182;</a>
        </div>
        <p>Next, extract the downloaded tarball into <code>cache_dir</code>.
The <code>user</code> and <code>group</code> attribute set who is running
this script and <code>cwd</code> sets your <em>Current Working
Directory</em>.</p>

<p>The <code>execute</code> resource will fire arbitrary shell commands
and is not idempotent by default. This means you either
need to ensure that your command does not have side
effects if run multiple times or that you use a <code>not_if</code>,
<code>only_if</code> or <code>creates</code> attribute as a guard.</p>

<p>We&rsquo;re using a <code>creates</code> attribute which simply says that
after <code>execute</code> runs, there should be a file or directory
equal to <code>"#{cache_dir}/#{tar_dir}"</code> on the system. The next
Chef run if this file or directory exists, the command
will be skipped.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">execute</span> <span class="s2">&quot;extract nginx tarball&quot;</span> <span class="k">do</span>
  <span class="n">user</span>      <span class="s2">&quot;root&quot;</span>
  <span class="n">group</span>     <span class="s2">&quot;root&quot;</span>
  <span class="n">cwd</span>       <span class="n">cache_dir</span>
  <span class="n">command</span>   <span class="sx">%{tar zxf </span><span class="si">#{</span><span class="n">tar_file</span><span class="si">}</span><span class="sx">}</span>
  <span class="n">creates</span>   <span class="s2">&quot;</span><span class="si">#{</span><span class="n">cache_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">tar_dir</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-Compilation_and_Installation'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Compilation_and_Installation">&#182;</a>
        </div>
        <h2>Compilation and Installation</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-16'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-16">&#182;</a>
        </div>
        <p>The most likely place for something to go wrong :) nginx
follows a very standard (and sane) build process of running
<code>./configure ...</code>, then <code>make</code> and <code>make install</code>.</p>

<p>We&rsquo;re using <code>creates</code> again so we don&rsquo;t recompile every single
time Chef runs and there&rsquo;s a special <code>notifies</code> attribute
which we can explain in a minute&hellip;</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">execute</span> <span class="s2">&quot;compile nginx&quot;</span> <span class="k">do</span>
  <span class="n">user</span>      <span class="s2">&quot;root&quot;</span>
  <span class="n">group</span>     <span class="s2">&quot;root&quot;</span>
  <span class="n">cwd</span>       <span class="s2">&quot;</span><span class="si">#{</span><span class="n">cache_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">tar_dir</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="n">command</span>   <span class="sx">%{./configure </span><span class="si">#{</span><span class="n">configure_flags</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="si">}</span><span class="sx"> &amp;&amp; make &amp;&amp; make install}</span>
  <span class="n">creates</span>   <span class="s2">&quot;/opt/</span><span class="si">#{</span><span class="n">tar_dir</span><span class="si">}</span><span class="s2">/sbin/nginx&quot;</span>
  <span class="n">notifies</span>  <span class="ss">:restart</span><span class="p">,</span> <span class="s2">&quot;service[nginx]&quot;</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-17'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-17">&#182;</a>
        </div>
        <p>Now we&rsquo;ll loop through a few directories that need to exist
for nginx to start. Here is a more traditional Ruby array of
strings, just to be different.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="o">[</span> <span class="s2">&quot;/var/log/nginx&quot;</span><span class="p">,</span> <span class="s2">&quot;/etc/nginx&quot;</span><span class="p">,</span>
  <span class="s2">&quot;/etc/nginx/conf.d&quot;</span><span class="p">,</span> <span class="s2">&quot;/etc/nginx/sites-enabled&quot;</span>
<span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">dir</span><span class="o">|</span>
  <span class="n">directory</span> <span class="n">dir</span> <span class="k">do</span>
    <span class="n">owner</span>       <span class="s2">&quot;root&quot;</span>
    <span class="n">group</span>       <span class="s2">&quot;root&quot;</span>
    <span class="n">mode</span>        <span class="s2">&quot;0755&quot;</span>
    <span class="n">recursive</span>   <span class="kp">true</span>
    <span class="n">action</span>      <span class="ss">:create</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-18'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-18">&#182;</a>
        </div>
        <p>A <code>cookbook_file</code> is a Chef managed file that will be fetch
from your cookbook repository. The name of this resource
is where you want the file installed and the <code>source</code> attribute
is the name of the file stored in your cookbook.</p>

<p>There are some tricks to storing multiple source files for
different operating systems and platform versions, but that&rsquo;s
out of scope here.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">cookbook_file</span> <span class="s2">&quot;/etc/nginx/nginx.conf&quot;</span> <span class="k">do</span>
  <span class="n">source</span>    <span class="s2">&quot;nginx.conf&quot;</span>
  <span class="n">owner</span>     <span class="s2">&quot;root&quot;</span>
  <span class="n">group</span>     <span class="s2">&quot;root&quot;</span>
  <span class="n">mode</span>      <span class="s2">&quot;0755&quot;</span>
  <span class="n">notifies</span>  <span class="ss">:restart</span><span class="p">,</span> <span class="s2">&quot;service[nginx]&quot;</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-19'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-19">&#182;</a>
        </div>
        <p>Same thing with our default nginx site configuration.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">cookbook_file</span> <span class="s2">&quot;/etc/nginx/sites-enabled/_default.conf&quot;</span> <span class="k">do</span>
  <span class="n">source</span>    <span class="s2">&quot;default-site.conf&quot;</span>
  <span class="n">owner</span>     <span class="s2">&quot;root&quot;</span>
  <span class="n">group</span>     <span class="s2">&quot;root&quot;</span>
  <span class="n">mode</span>      <span class="s2">&quot;0755&quot;</span>
  <span class="n">notifies</span>  <span class="ss">:restart</span><span class="p">,</span> <span class="s2">&quot;service[nginx]&quot;</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-20'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-20">&#182;</a>
        </div>
        <p>Same here with our init.d rc script.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">cookbook_file</span> <span class="s2">&quot;/etc/init.d/nginx&quot;</span> <span class="k">do</span>
  <span class="n">source</span>    <span class="s2">&quot;nginx.init&quot;</span>
  <span class="n">owner</span>     <span class="s2">&quot;root&quot;</span>
  <span class="n">group</span>     <span class="s2">&quot;root&quot;</span>
  <span class="n">mode</span>      <span class="s2">&quot;0755&quot;</span>
  <span class="n">notifies</span>  <span class="ss">:restart</span><span class="p">,</span> <span class="s2">&quot;service[nginx]&quot;</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-21'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-21">&#182;</a>
        </div>
        <p>Finally we can register a service called <code>nginx</code>. By default,
this corresponds to a system service and is platform dependant.
In our case with Ubuntu, this is an init.d style service.</p>

<p>Since we are managing our own rc script, we can tell Chef
what functionality our script supports such as being able to
restart, reload, and get a status. Setting these values to
false will cause Chef to use other tricks (possibly grepping
through <code>ps</code> output) to accomplish the same tasks.</p>

<p>Once a serive is registered it can get notified to restart, stop,
etc. from other Chef resources. This is what the
<code>notifies :restart, "service[nginx]</code> business was about in the
cookbook files. This is a way to tell Chef: &ldquo;when is file changes,
I need you to restart the web server&rdquo;. By default, this
action is delayed until the end of your Chef run, but you can
override it if you need it to be immediate.</p>

<p>Finally, we have 2 actions here which is different. We want to
enable (register with the operating system) and start nginx.
Fancypants!</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">service</span> <span class="s2">&quot;nginx&quot;</span> <span class="k">do</span>
  <span class="n">supports</span>  <span class="ss">:restart</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:reload</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:status</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="n">action</span>    <span class="o">[</span> <span class="ss">:enable</span><span class="p">,</span> <span class="ss">:start</span> <span class="o">]</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-22'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-22">&#182;</a>
        </div>
        <p>And that&rsquo;s it. Are you still here? I thought you&rsquo;d be out buying
a coffee with all this spare time you&rsquo;ve freed up.</p>

      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
