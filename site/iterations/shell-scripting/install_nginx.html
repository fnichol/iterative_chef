<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>install_nginx.sh</title>
  <link rel="stylesheet" href="http://github.com/jashkenas/docco/raw/0.3.0/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>install_nginx.sh</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-Convenience_Functions'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Convenience_Functions">&#182;</a>
        </div>
        <h2>Convenience Functions</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p>Set up a simple function to print logging info so that the user
can follow the script output</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>log<span class="o">()</span> <span class="o">{</span> <span class="nb">printf</span> <span class="s2">&quot;===&gt; $*\n&quot;</span> ; <span class="k">return</span> <span class="nv">$?</span> ; <span class="o">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-4">&#182;</a>
        </div>
        <p>A quick function to handle error-and-quit situtations.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>fail<span class="o">()</span>  <span class="o">{</span> <span class="nb">printf</span> <span class="s2">&quot;\n&gt;&gt; ERROR: $*\n\n&quot;</span> ; <span class="nb">exit </span>1 ; <span class="o">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p>Ensure that the calling user is root and fail otherwise. This
way we don&rsquo;t need to worry about which commands require sudo.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="o">[[</span> <span class="nv">$UID</span> -ne 0 <span class="o">]]</span> <span class="o">&amp;&amp;</span> fail <span class="s2">&quot;You must be root to run this installer&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-Variables'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Variables">&#182;</a>
        </div>
        <h2>Variables</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <p>The directory that tarballs will be downloaded to.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nv">cache_dir</span><span class="o">=</span><span class="s2">&quot;/var/cache/downloads&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <p>The full URL to download the nginx tarball.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nv">tar_url</span><span class="o">=</span><span class="s2">&quot;http://nginx.org/download/nginx-0.9.7.tar.gz&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-9">&#182;</a>
        </div>
        <p>The name of the tarball without the URL at the beggining. There
is some Bash variable manging going on here with
<a href="http://www.linuxjournal.com/article/8919">string operators</a>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nv">tar_file</span><span class="o">=</span><span class="s2">&quot;${tar_url##http*/}&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <p>The directory that will get created when extracting the tarball.
Same variable mangling tricks here too (strip <code>.tar.gz</code> off the
end of <code>$tar_file</code>).</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nv">tar_dir</span><span class="o">=</span><span class="s2">&quot;${tar_file%.tar.gz}&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-11">&#182;</a>
        </div>
        <p>The configure flags used when configuring nginx. We&rsquo;re targetting
a custom directory in <code>/opt</code> so that multiple built versions of
nginx can co-exist together. We&rsquo;re also enabling the SSL module
which is bound to be used sooner or later.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nv">configure_flags</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">  --prefix=/opt/${tar_dir}</span>
<span class="s2">  --conf-path=/etc/nginx/nginx.conf</span>
<span class="s2">  --with-http_ssl_module</span>
<span class="s2">&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-12'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-12">&#182;</a>
        </div>
        <p>A list of Ubuntu packages that must be installed prior to
compiling nginx. We also want the <em>wget</em> package to fetch
the tarball. It&rsquo;s installed by default in Ubuntu base, but
no harm in being explicit.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nv">pkgs</span><span class="o">=(</span> wget build-essential binutils-doc autoconf flex bison
       libpcre3 libpcre3-dev libssl-dev <span class="o">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-Install_Pre-requisite_Packages'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Install_Pre-requisite_Packages">&#182;</a>
        </div>
        <h2>Install Pre-requisite Packages</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-14'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-14">&#182;</a>
        </div>
        <p>Loop through the <code>$pkgs</code> array and install each package
on its own. We could have done this as one command but
installing individually might help us catch any errors
and zero in on the bad package.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>log <span class="s2">&quot;Installing packages&quot;</span>
<span class="k">for </span>pkg in <span class="s2">&quot;${pkgs[@]}&quot;</span> ; <span class="k">do</span>
<span class="k">  </span>log <span class="s2">&quot;Installing ${pkg}...&quot;</span>
  apt-get install -y <span class="nv">$pkg</span>
<span class="k">done</span> ; <span class="nb">unset </span>pkg</pre></div>
      </td>
    </tr>
    <tr id='section-Fetching_and_Extraction'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Fetching_and_Extraction">&#182;</a>
        </div>
        <h2>Fetching and Extraction</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-16'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-16">&#182;</a>
        </div>
        <p>Ensure that the <code>$cache_dir</code> directory exists and has
sane permissions and ownership. The <code>-p</code> flag in <code>mkdir</code>
will create any missing parent directories.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>log <span class="s2">&quot;Creating a download cache directory in $cache_dir&quot;</span>
mkdir -p <span class="nv">$cache_dir</span>
chown root:root <span class="nv">$cache_dir</span>
chmod 755 <span class="nv">$cache_dir</span></pre></div>
      </td>
    </tr>
    <tr id='section-17'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-17">&#182;</a>
        </div>
        <p>Download the the nginx tarball into the <code>$cache_dir</code>
directory. First, we&rsquo;ll remove any pre-existing tarballs
so that <em>wget</em> won&rsquo;t download the tarball to a different
file (appending <code>.1</code> to the end which is lamesauce for
our use case).</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>log <span class="s2">&quot;Downloading nginx tarball from $tar_url&quot;</span>
rm -f <span class="nv">$cache_dir</span>/<span class="nv">$tar_file</span>
<span class="o">(</span><span class="nb">cd</span> <span class="nv">$cache_dir</span> <span class="o">&amp;&amp;</span> wget <span class="nv">$tar_url</span><span class="o">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-18'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-18">&#182;</a>
        </div>
        <p>Next, extract the downloaded tarball into <code>$cache_dir</code>
so we have a place to build it. We&rsquo;ll also kill any
old extracted directories.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>log <span class="s2">&quot;Extracting nginx tarball into $cache_dir&quot;</span>
rm -rf <span class="nv">$cache_dir</span>/<span class="nv">$tar_dir</span>
<span class="o">(</span><span class="nb">cd</span> <span class="nv">$cache_dir</span> <span class="o">&amp;&amp;</span> tar zxf <span class="nv">$tar_file</span><span class="o">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-Compilation_and_Installation'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Compilation_and_Installation">&#182;</a>
        </div>
        <h2>Compilation and Installation</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-20'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-20">&#182;</a>
        </div>
        <p>The most likely place for something to go wrong :) nginx
follows a very standard (and sane) build process of running
<code>./configure ...</code>, then <code>make</code> and <code>make install</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>log <span class="s2">&quot;Building nginx&quot;</span>
<span class="o">(</span><span class="nb">cd</span> <span class="nv">$cache_dir</span>/<span class="nv">$tar_dir</span> <span class="o">&amp;&amp;</span> ./configure <span class="nv">$configure_flags</span><span class="o">)</span>
<span class="o">(</span><span class="nb">cd</span> <span class="nv">$cache_dir</span>/<span class="nv">$tar_dir</span> <span class="o">&amp;&amp;</span> make <span class="o">&amp;&amp;</span> make install<span class="o">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-21'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-21">&#182;</a>
        </div>
        <p>And that&rsquo;s it, thanks for playing along.</p>

      </td>
      <td class=code>
        <div class='highlight'><pre>log <span class="s2">&quot;Installation of nginx is complete, w00t\!&quot;</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
